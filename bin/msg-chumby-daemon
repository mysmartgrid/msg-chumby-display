#!/usr/bin/env ruby

libpath=File.join(File.dirname(__FILE__), '..', 'lib')
$:.unshift << libpath 
#puts "Using library path #{$:.join(":")}" 
require 'rubygems'
require 'lib/msg-chumby-daemon.rb'

reading_cache=MSG_Chumby::Reading_Cache.new();
$demo_importer=MSG_Chumby::DemoReadingImporter.new(reading_cache, 400);
$importer_thread=nil;
$server=MSG_Chumby::HTTP_XML_Server.new("127.0.0.1", 3000, reading_cache);

def startAll
  $server.start();
  $importer_thread=Thread.new() {
    $demo_importer.doWork();
  }
  $server.join();
  $importer_thread.join();
end

def stopAll
  $server.stop() 
  $importer_thread.stop() unless $importer_thread.stop?;
  exit;
end

trap("INT") {stopAll();}
trap("KILL") {stopAll();}
startAll();
